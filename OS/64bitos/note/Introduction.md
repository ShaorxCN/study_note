# 大体介绍

包含章节 
- [1.操作系统概述](#c1)
- [2.环境搭建以及基础知识](#c2)
    - [2.1 c与汇编](#c3)
        - [汇编调用c约定](#c3-1)
        - [c内嵌汇编](#c3-2)



<img src="./img/all-level.png">

<div id=c1><h2>组成结构</h2></div>

- 引导启动:BIOS上电自检到跳转到内核程序执行之前这一段  主要检测计算机硬件以及配置内核运行参数。曾经分为两个部分 Boot和Loader 现在通常合二为一 统称为BootLoader(Grub 和 Uboot)(之前是因为大小限制(512字节 一个软盘扇区) boot加载loader loader再加载os，自检等任务实际是loader做的)
- 内存管理:这个可以参看blog-os中的一部分。tip 红黑树
- 异常/中断处理:也可以参考blogos.注意的是这里通常分为中断上半部和中断下半部。参考异步键盘程序。保证中断尽可能短。下半部甚至可以将处理内容放在一个单独的进程中。当然这个进程的优先级需要更高。
- 进程管理: 主要是进程调度和进程间通信(SIGNAL信号 管道 共享内存  信号量等)
- 设备驱动:设备和内核的交互  为了实现即插即用 将驱动程序从内核中移出 使用时动态挂载到内核空间
- 文件系统: 所有扇区的管理 包括内存块。组成一个RAMDisk（内存式硬盘或者说虚拟内存盘）将一部分内存模拟成内存使用。  这只是一个模块功能 并不是文件系统本身。比如sys文件系统 FAT类文件系统  EXT类文件系统。
- 系统调用API库: 主要是提供给应用程序使用的接口
- 应用程序: 自己安装或者系统自带的工具 软件和服务。

该项目 主要分为三个部分：
- 引导启动:使用NASM汇编语言编写  实现u盘引导启动 文件系统识别 系统内核加载 内存容量检测  显示模式检测和设置  处理器运行模式切换  页表配置等功能。
- 内核层:  参看linux内核编写一个内核雏形。遵循POSIX(可移植操作系统接口 Portable Operating System Interface of UNIX，缩写为 POSIX)规范  提供系统调用API
- 应用层: 实现Shell命令解析器和一些基础命令。


<div id=c2><h2>环境搭建以及基础知识</h2></div>


虚拟机安装 主要是 平台构建 这里我使用vscode 就用它的wsl功能了。

### 语言选择

Intel汇编以及AT&T汇编语言格式对比

<img src="./img/asm_diff.png">

<div id = "c3"><h3>汇编语言与C语言函数</h3></div>

参见 example/objtest_asm_part.asm

<div id = "c3-1"><h4>汇编语言调用C语言函数</h4></div>
其中函数的调用约定有几种常见的:

- stdcall
    - 调用函数的时候 参数右向左入栈 比如下面的function函数 入栈顺序是second,first:`int function(int first,int second)`
    - 函数的栈平衡操作（参数出栈）由被调用函数完成。 比如function函数会有类似`retn x`的指令 值得就是弹栈x个字节。
    - 会在函数名前下划线，结尾@修饰并且加上栈的字节数。同理 function函数类似`_function@8`
- cdecl
    - 参数压栈顺序同上(右向左)
    - 栈平衡操作由调用函数完成，类似`leave,pop`等指令完成
    - 因为每个函数调用者都有栈平衡代码 所以可执行文件大于stdcall。他是GNU C编译器的默认调用约定。但是GNU C在64位系统下 使用寄存器传递参数。左向右的六个整型参数放入RDI，RSI，RDX，RCX，R9和R9中。XMM0-XMM7用来保存浮点变量。RAX保存函数返回值。
- fastcall
    - 一般尽可能使用ECX和EDX传递参数。通常是前两个int类型的参数或者较小的参数。其他的也是右向左入栈。
  

寄存器传递参数和内存(栈传递)的比较（**基于x86**）

- 寄存器:有点自然是速度快。但是只能少数约定使用寄存器传递参数。基于x86的linux 系统api一般使用寄存器传递。因为应用层空间和内核空间是隔离的 。所以如果需要从应用层转递到内核层 最好使用寄存器传递。不然会比较麻烦（因为隔离的原因）
- 内存传递方式:大多数就是使用这种。 比如x86下 对于中断/异常处理  存在汇编跳转到c函数。c一般使用栈传递参数 所以这里汇编最好也是使用栈传递。
  

<div id = "c3-2"><h4>C语言函数内嵌汇编语言</h4></div>

`GNU C`使用关键字 `asm`声明代码是内嵌的汇编语句:

```C
// volatile 禁止编译器优化
#define nop() __asm__ __volatile__("nop    \n\t")
```

- `__asm__`关键字：他是关键字asm的宏定义(`#define __asm__ asm`)。也就说也可以使用asm关键字。为了兼容ANSI C标准 建议使用`__asm__`
- `__volatile__`:告诉编译器不要优化。


内嵌方式:分为三个部分说明

- 内嵌汇编表达式：因为c本身也会被解释称汇编语言。或者说本身也是执行在计算机体系中。那么内嵌汇编会比单独使用任何一个都更复杂。需要考虑确定寄存器的工作情况，与c语言融合情况等。GNU C中一般由四部分组成 中间用`:`分割：<br>`指令部分:输出部分:输入部分：损坏部分`<br>这几个部分来说明上面的一些需要考虑的点。





